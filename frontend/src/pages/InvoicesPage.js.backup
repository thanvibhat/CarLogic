import React, { useState, useEffect } from 'react';
import axios from 'axios';
import { API } from '../App';
import { Button } from '../components/ui/button';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/card';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger, DialogFooter } from '../components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '../components/ui/select';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '../components/ui/table';
import { toast } from 'sonner';
import { Plus, Download, Mail, Eye } from 'lucide-react';
import jsPDF from 'jspdf';
import 'jspdf-autotable';
import { format } from 'date-fns';
import { useSettings } from '../hooks/useSettings';

export default function InvoicesPage() {
  const { formatCurrency, settings, getCurrencySymbol } = useSettings();
  const [invoices, setInvoices] = useState([]);
  const [bookings, setBookings] = useState([]);
  const [customers, setCustomers] = useState([]);
  const [open, setOpen] = useState(false);
  const [previewOpen, setPreviewOpen] = useState(false);
  const [emailOpen, setEmailOpen] = useState(false);
  const [selectedInvoice, setSelectedInvoice] = useState(null);
  const [emailAddress, setEmailAddress] = useState('');
  const [formData, setFormData] = useState({ 
    booking_id: '', 
    discount_percentage: '0',
    discount_amount: '0',
    invoice_prefix: ''
  });
  const [previewData, setPreviewData] = useState(null);

  useEffect(() => {
    fetchInvoices();
    fetchBookings();
    fetchCustomers();
    fetchLatestPrefix();
  }, []);

  useEffect(() => {
    if (formData.booking_id) {
      calculatePreview();
    }
  }, [formData.booking_id, formData.discount_percentage, formData.discount_amount]);

  const fetchLatestPrefix = async () => {
    try {
      const response = await axios.get(`${API}/invoices/latest-prefix`);
      setFormData(prev => ({ ...prev, invoice_prefix: response.data.prefix || '' }));
    } catch (error) {
      console.error('Failed to fetch latest prefix', error);
    }
  };

  const fetchInvoices = async () => {
    try {
      const response = await axios.get(`${API}/invoices`);
      setInvoices(response.data);
    } catch (error) {
      toast.error('Failed to fetch invoices');
    }
  };

  const fetchBookings = async () => {
    try {
      const response = await axios.get(`${API}/bookings`);
      setBookings(response.data.filter(b => b.status === 'Completed'));
    } catch (error) {
      console.error('Failed to fetch bookings', error);
    }
  };

  const fetchCustomers = async () => {
    try {
      const response = await axios.get(`${API}/customers`);
      setCustomers(response.data);
    } catch (error) {
      console.error('Failed to fetch customers', error);
    }
  };

  const calculatePreview = async () => {
    if (!formData.booking_id) return;
    
    try {
      const booking = bookings.find(b => b.booking_id === formData.booking_id);
      if (!booking) return;

      const productsRes = await axios.get(`${API}/products`);
      const products = productsRes.data.filter(p => booking.product_ids.includes(p.product_id));
      
      const allTaxIds = [];
      products.forEach(p => allTaxIds.push(...p.tax_ids));
      
      let taxesMap = {};
      if (allTaxIds.length > 0) {
        const taxesRes = await axios.get(`${API}/taxes`);
        taxesRes.data.forEach(t => {
          if (allTaxIds.includes(t.tax_id)) {
            taxesMap[t.tax_id] = t;
          }
        });
      }

      let subtotal = 0;
      const items = [];
      const taxBreakdown = {};

      products.forEach(product => {
        const itemPrice = product.sell_price;
        let itemTaxAmount = 0;

        product.tax_ids.forEach(taxId => {
          if (taxesMap[taxId]) {
            const tax = taxesMap[taxId];
            const taxAmt = (itemPrice * tax.percentage / 100);
            itemTaxAmount += taxAmt;
            
            if (!taxBreakdown[tax.name]) {
              taxBreakdown[tax.name] = { percentage: tax.percentage, amount: 0 };
            }
            taxBreakdown[tax.name].amount += taxAmt;
          }
        });

        items.push({
          product_name: product.name,
          price: itemPrice,
          tax_amount: itemTaxAmount,
          total: itemPrice + itemTaxAmount
        });
        subtotal += itemPrice;
      });

      const totalTax = Object.values(taxBreakdown).reduce((sum, t) => sum + t.amount, 0);
      const beforeDiscount = subtotal + totalTax;
      
      let discountAmount = parseFloat(formData.discount_amount) || 0;
      let discountPercentage = parseFloat(formData.discount_percentage) || 0;
      
      const total = beforeDiscount - discountAmount;

      setPreviewData({
        items,
        subtotal,
        taxBreakdown,
        totalTax,
        beforeDiscount,
        discountAmount,
        discountPercentage,
        total,
        customer: customers.find(c => c.customer_id === booking.customer_id)
      });
    } catch (error) {
      console.error('Failed to calculate preview', error);
    }
  };

  const handleDiscountPercentageChange = (value) => {
    if (!previewData) {
      setFormData({ ...formData, discount_percentage: value, discount_amount: '0' });
      return;
    }
    
    const percentage = parseFloat(value) || 0;
    const amount = (previewData.beforeDiscount * percentage / 100).toFixed(2);
    setFormData({ ...formData, discount_percentage: value, discount_amount: amount });
  };

  const handleDiscountAmountChange = (value) => {
    if (!previewData) {
      setFormData({ ...formData, discount_amount: value, discount_percentage: '0' });
      return;
    }
    
    const amount = parseFloat(value) || 0;
    const percentage = previewData.beforeDiscount > 0 
      ? ((amount / previewData.beforeDiscount) * 100).toFixed(2)
      : '0';
    setFormData({ ...formData, discount_amount: value, discount_percentage: percentage });
  };

  const handleSubmit = async (e) => {
    e.preventDefault();
    try {
      const data = {
        booking_id: formData.booking_id,
        discount_percentage: parseFloat(formData.discount_percentage),
        invoice_prefix: formData.invoice_prefix
      };
      const response = await axios.post(`${API}/invoices`, data);
      toast.success('Invoice created successfully');
      setOpen(false);
      setFormData({ booking_id: '', discount_percentage: '0', discount_amount: '0', invoice_prefix: response.data.invoice_prefix || '' });
      setPreviewData(null);
      fetchInvoices();
      
      const fullInvoice = await axios.get(`${API}/invoices/${response.data.invoice_id}`);
      const customer = customers.find(c => c.customer_id === fullInvoice.data.customer_id);
      generatePDF(fullInvoice.data, customer);
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Invoice creation failed');
    }
  };

  const generatePDF = (invoice, customer) => {
    try {
      const doc = new jsPDF();
      const customerName = customer?.name || 'N/A';
      const customerPhone = customer?.phone || 'N/A';
      const fullInvoiceNumber = `${invoice.invoice_prefix || ''}${invoice.invoice_number || ''}`;

      doc.setFontSize(20);
      doc.setFont('helvetica', 'bold');
      doc.text('Car Logic Car Wash', 105, 20, { align: 'center' });
      
      doc.setFontSize(16);
      doc.text('INVOICE', 105, 30, { align: 'center' });

      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text(`Invoice Number: ${fullInvoiceNumber}`, 20, 45);
      doc.text(`Date: ${format(new Date(invoice.created_at), 'PPP')}`, 20, 52);
      doc.text(`Customer: ${customerName}`, 20, 59);
      doc.text(`Phone: ${customerPhone}`, 20, 66);

      const tableData = invoice.items.map(item => [
        item.product_name,
        `$${item.price.toFixed(2)}`,
        `$${item.tax_amount.toFixed(2)}`,
        `$${item.total.toFixed(2)}`
      ]);

      doc.autoTable({
        startY: 75,
        head: [['Service', 'Price', 'Tax', 'Total']],
        body: tableData,
        theme: 'grid',
        headStyles: { fillColor: [0, 102, 255] }
      });

      const finalY = doc.lastAutoTable.finalY + 10;

      doc.setFontSize(11);
      doc.text(`Subtotal:`, 130, finalY);
      doc.text(`$${invoice.subtotal.toFixed(2)}`, 180, finalY, { align: 'right' });

      doc.text(`Tax:`, 130, finalY + 7);
      doc.text(`$${invoice.tax_amount.toFixed(2)}`, 180, finalY + 7, { align: 'right' });

      if (invoice.discount_percentage > 0) {
        doc.text(`Discount (${invoice.discount_percentage}%):`, 130, finalY + 14);
        doc.text(`-$${invoice.discount_amount.toFixed(2)}`, 180, finalY + 14, { align: 'right' });
      }

      doc.setFont('helvetica', 'bold');
      doc.setFontSize(12);
      const totalY = invoice.discount_percentage > 0 ? finalY + 21 : finalY + 14;
      doc.text(`Total:`, 130, totalY);
      doc.text(`$${invoice.total.toFixed(2)}`, 180, totalY, { align: 'right' });

      doc.save(`invoice_${fullInvoiceNumber}.pdf`);
    } catch (error) {
      console.error('PDF generation error:', error);
      toast.error('Failed to generate PDF');
    }
  };

  const handleDownload = async (invoiceId) => {
    try {
      const response = await axios.get(`${API}/invoices/${invoiceId}`);
      const customer = customers.find(c => c.customer_id === response.data.customer_id);
      generatePDF(response.data, customer);
    } catch (error) {
      toast.error('Failed to download invoice');
    }
  };

  const handlePreview = async (invoiceId) => {
    try {
      const response = await axios.get(`${API}/invoices/${invoiceId}`);
      const customer = customers.find(c => c.customer_id === response.data.customer_id);
      setSelectedInvoice({ ...response.data, customer });
      setPreviewOpen(true);
    } catch (error) {
      toast.error('Failed to load invoice');
    }
  };

  const handleEmailInvoice = async () => {
    if (!emailAddress) {
      toast.error('Please enter an email address');
      return;
    }
    try {
      await axios.post(`${API}/invoices/email`, {
        invoice_id: selectedInvoice.invoice_id,
        recipient_email: emailAddress
      });
      toast.success(`Invoice emailed to ${emailAddress}`);
      setEmailOpen(false);
      setEmailAddress('');
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Failed to send email');
    }
  };

  const getCustomerName = (customerId) => {
    const customer = customers.find(c => c.customer_id === customerId);
    return customer?.name || '-';
  };

  const getFullInvoiceNumber = (invoice) => {
    return `${invoice.invoice_prefix || ''}${invoice.invoice_number || invoice.invoice_id.slice(0, 8)}`;
  };

  return (
    <div className="space-y-6" data-testid="invoices-page">
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-2xl md:text-3xl font-heading font-bold text-slate-900" data-testid="invoices-title">Invoices</h1>
          <p className="text-slate-600 mt-1">Generate and manage invoices</p>
        </div>
        <Dialog open={open} onOpenChange={setOpen}>
          <DialogTrigger asChild>
            <Button 
              className="rounded-full shadow-lg shadow-primary/20" 
              onClick={() => { 
                fetchLatestPrefix();
                setFormData({ booking_id: '', discount_percentage: '0', discount_amount: '0', invoice_prefix: '' });
                setPreviewData(null);
              }} 
              data-testid="add-invoice-button"
            >
              <Plus className="h-4 w-4 mr-2" />
              Generate Invoice
            </Button>
          </DialogTrigger>
          <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto" data-testid="invoice-dialog">
            <DialogHeader>
              <DialogTitle>Generate New Invoice</DialogTitle>
            </DialogHeader>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div className="space-y-2">
                <Label htmlFor="invoice_prefix">Invoice Prefix (Optional)</Label>
                <Input
                  id="invoice_prefix"
                  placeholder="e.g., INV-2025-"
                  value={formData.invoice_prefix}
                  onChange={(e) => setFormData({ ...formData, invoice_prefix: e.target.value })}
                  data-testid="invoice-prefix-input"
                />
                <p className="text-xs text-slate-500">Previous prefix will be auto-filled. Edit as needed.</p>
              </div>

              <div className="space-y-2">
                <Label htmlFor="booking">Completed Booking *</Label>
                <Select 
                  value={formData.booking_id} 
                  onValueChange={(value) => setFormData({ ...formData, booking_id: value })} 
                  required
                >
                  <SelectTrigger data-testid="invoice-booking-select">
                    <SelectValue placeholder="Select booking" />
                  </SelectTrigger>
                  <SelectContent>
                    {bookings.map((booking) => {
                      const customer = customers.find(c => c.customer_id === booking.customer_id);
                      return (
                        <SelectItem key={booking.booking_id} value={booking.booking_id}>
                          {customer?.name} - Booking #{booking.booking_id.slice(0, 8)} - {format(new Date(booking.appointment_datetime), 'PPP')}
                        </SelectItem>
                      );
                    })}
                  </SelectContent>
                </Select>
              </div>

              {previewData && (
                <Card className="bg-slate-50">
                  <CardHeader>
                    <CardTitle className="text-lg">Invoice Preview</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div>
                      <p className="text-sm font-medium text-slate-600 mb-2">Customer</p>
                      <p className="font-semibold">{previewData.customer?.name}</p>
                    </div>
                    
                    <div>
                      <p className="text-sm font-medium text-slate-600 mb-2">Services</p>
                      <div className="space-y-1">
                        {previewData.items.map((item, idx) => (
                          <div key={idx} className="flex justify-between text-sm">
                            <span>{item.product_name}</span>
                            <span className="font-medium">${item.total.toFixed(2)}</span>
                          </div>
                        ))}
                      </div>
                    </div>

                    <div className="border-t pt-3">
                      <div className="flex justify-between text-sm">
                        <span>Subtotal:</span>
                        <span className="font-medium">${previewData.subtotal.toFixed(2)}</span>
                      </div>
                      
                      <div className="mt-2 space-y-1">
                        <p className="text-xs font-medium text-slate-600">Tax Bifurcation:</p>
                        {Object.entries(previewData.taxBreakdown).map(([name, data]) => (
                          <div key={name} className="flex justify-between text-xs text-slate-600">
                            <span>{name} ({data.percentage}%):</span>
                            <span>${data.amount.toFixed(2)}</span>
                          </div>
                        ))}
                      </div>
                      
                      <div className="flex justify-between text-sm mt-2">
                        <span>Total Tax:</span>
                        <span className="font-medium">${previewData.totalTax.toFixed(2)}</span>
                      </div>

                      {previewData.discountAmount > 0 && (
                        <div className="flex justify-between text-sm text-green-600">
                          <span>Discount ({previewData.discountPercentage}%):</span>
                          <span className="font-medium">-${previewData.discountAmount.toFixed(2)}</span>
                        </div>
                      )}

                      <div className="flex justify-between text-base font-bold mt-3 pt-3 border-t">
                        <span>Final Total:</span>
                        <span className="text-primary">${previewData.total.toFixed(2)}</span>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              )}

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor="discount_percentage">Discount %</Label>
                  <Input
                    id="discount_percentage"
                    type="number"
                    step="0.01"
                    min="0"
                    max="100"
                    value={formData.discount_percentage}
                    onChange={(e) => handleDiscountPercentageChange(e.target.value)}
                    data-testid="invoice-discount-percentage-input"
                  />
                </div>
                <div className="space-y-2">
                  <Label htmlFor="discount_amount">Discount Amount</Label>
                  <Input
                    id="discount_amount"
                    type="number"
                    step="0.01"
                    min="0"
                    value={formData.discount_amount}
                    onChange={(e) => handleDiscountAmountChange(e.target.value)}
                    data-testid="invoice-discount-amount-input"
                  />
                </div>
              </div>

              <DialogFooter>
                <Button type="submit" className="rounded-full" data-testid="invoice-submit-button">
                  Generate Invoice & Download PDF
                </Button>
              </DialogFooter>
            </form>
          </DialogContent>
        </Dialog>
      </div>

      {/* Invoice Preview Modal */}
      <Dialog open={previewOpen} onOpenChange={setPreviewOpen}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Invoice Preview</DialogTitle>
          </DialogHeader>
          {selectedInvoice && (
            <div className="space-y-4">
              <div className="text-center border-b pb-4">
                <h2 className="text-2xl font-heading font-bold">Car Logic Car Wash</h2>
                <p className="text-lg font-semibold mt-2">INVOICE</p>
              </div>

              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <p className="font-semibold">Invoice Number:</p>
                  <p>{getFullInvoiceNumber(selectedInvoice)}</p>
                </div>
                <div>
                  <p className="font-semibold">Date:</p>
                  <p>{format(new Date(selectedInvoice.created_at), 'PPP')}</p>
                </div>
                <div>
                  <p className="font-semibold">Customer:</p>
                  <p>{selectedInvoice.customer?.name || 'N/A'}</p>
                </div>
                <div>
                  <p className="font-semibold">Phone:</p>
                  <p>{selectedInvoice.customer?.phone || 'N/A'}</p>
                </div>
              </div>

              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead>Service</TableHead>
                    <TableHead>Price</TableHead>
                    <TableHead>Tax</TableHead>
                    <TableHead>Total</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {selectedInvoice.items.map((item, idx) => (
                    <TableRow key={idx}>
                      <TableCell>{item.product_name}</TableCell>
                      <TableCell>${item.price.toFixed(2)}</TableCell>
                      <TableCell>${item.tax_amount.toFixed(2)}</TableCell>
                      <TableCell>${item.total.toFixed(2)}</TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>

              <div className="border-t pt-4 space-y-2">
                <div className="flex justify-between">
                  <span>Subtotal:</span>
                  <span className="font-medium">${selectedInvoice.subtotal.toFixed(2)}</span>
                </div>
                <div className="flex justify-between">
                  <span>Tax:</span>
                  <span className="font-medium">${selectedInvoice.tax_amount.toFixed(2)}</span>
                </div>
                {selectedInvoice.discount_percentage > 0 && (
                  <div className="flex justify-between text-green-600">
                    <span>Discount ({selectedInvoice.discount_percentage}%):</span>
                    <span className="font-medium">-${selectedInvoice.discount_amount.toFixed(2)}</span>
                  </div>
                )}
                <div className="flex justify-between text-lg font-bold border-t pt-2">
                  <span>Total:</span>
                  <span className="text-primary">${selectedInvoice.total.toFixed(2)}</span>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Email Invoice Modal */}
      <Dialog open={emailOpen} onOpenChange={setEmailOpen}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>Email Invoice</DialogTitle>
          </DialogHeader>
          <div className="space-y-4">
            <div className="space-y-2">
              <Label htmlFor="email_address">Recipient Email</Label>
              <Input
                id="email_address"
                type="email"
                placeholder="customer@example.com"
                value={emailAddress}
                onChange={(e) => setEmailAddress(e.target.value)}
                data-testid="email-address-input"
              />
            </div>
            <DialogFooter>
              <Button onClick={handleEmailInvoice} className="rounded-full" data-testid="send-email-button">
                <Mail className="h-4 w-4 mr-2" />
                Send Email
              </Button>
            </DialogFooter>
          </div>
        </DialogContent>
      </Dialog>

      <Card className="border-slate-100 shadow-sm" data-testid="invoices-table-card">
        <CardHeader>
          <CardTitle>Invoice List</CardTitle>
        </CardHeader>
        <CardContent className="overflow-x-auto">
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead>Invoice Number</TableHead>
                <TableHead>Customer</TableHead>
                <TableHead className="hidden md:table-cell">Date</TableHead>
                <TableHead>Total</TableHead>
                <TableHead className="text-right">Actions</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {invoices.map((invoice) => (
                <TableRow key={invoice.invoice_id} data-testid={`invoice-row-${invoice.invoice_id}`}>
                  <TableCell className="font-medium">{getFullInvoiceNumber(invoice)}</TableCell>
                  <TableCell>{getCustomerName(invoice.customer_id)}</TableCell>
                  <TableCell className="hidden md:table-cell">{format(new Date(invoice.created_at), 'PPP')}</TableCell>
                  <TableCell className="font-semibold">${invoice.total.toFixed(2)}</TableCell>
                  <TableCell className="text-right">
                    <div className="flex justify-end gap-2">
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handlePreview(invoice.invoice_id)}
                        data-testid={`preview-invoice-${invoice.invoice_id}`}
                      >
                        <Eye className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => {
                          setSelectedInvoice(invoice);
                          const customer = customers.find(c => c.customer_id === invoice.customer_id);
                          setEmailAddress(customer?.email || '');
                          setEmailOpen(true);
                        }}
                        data-testid={`email-invoice-${invoice.invoice_id}`}
                      >
                        <Mail className="h-4 w-4" />
                      </Button>
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => handleDownload(invoice.invoice_id)}
                        data-testid={`download-invoice-${invoice.invoice_id}`}
                      >
                        <Download className="h-4 w-4" />
                      </Button>
                    </div>
                  </TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
          {invoices.length === 0 && (
            <p className="text-center text-slate-500 py-8">No invoices found. Generate your first invoice!</p>
          )}
        </CardContent>
      </Card>
    </div>
  );
}